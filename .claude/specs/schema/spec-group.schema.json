{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "SpecGroup",
  "description": "A collection of atomic specs tied to a PRD version, with two-dimensional state tracking",
  "type": "object",
  "required": ["id", "title", "review_state", "work_state", "created_at"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^sg-[a-z0-9-]+$",
      "description": "Unique identifier for the spec group (sg-<slug>)"
    },
    "title": {
      "type": "string",
      "description": "Human-readable title for the spec group"
    },
    "prd": {
      "type": "object",
      "description": "Link to external PRD (null if local-only)",
      "properties": {
        "source": {
          "type": "string",
          "enum": ["google-docs", "notion", "local"],
          "description": "Where the PRD lives"
        },
        "document_id": {
          "type": "string",
          "description": "External document ID (for google-docs/notion)"
        },
        "version": {
          "type": "string",
          "pattern": "^v[0-9]+$",
          "description": "PRD version this spec group is tied to (v1, v2, etc.)"
        },
        "last_sync": {
          "type": "string",
          "format": "date-time",
          "description": "Last time requirements were synced from PRD"
        },
        "url": {
          "type": "string",
          "format": "uri",
          "description": "Direct URL to the PRD document"
        }
      },
      "required": ["source"]
    },
    "review_state": {
      "type": "string",
      "enum": ["DRAFT", "REVIEWED", "APPROVED"],
      "description": "Has the user approved this spec group? DRAFT=needs review, REVIEWED=user has seen it, APPROVED=ready for implementation"
    },
    "work_state": {
      "type": "string",
      "enum": [
        "PLAN_READY",
        "IMPLEMENTING",
        "VERIFYING",
        "READY_TO_MERGE",
        "MERGED"
      ],
      "description": "Where is the implementation? PLAN_READY=not started, IMPLEMENTING=in progress, VERIFYING=gates running, READY_TO_MERGE=all gates passed, MERGED=done"
    },
    "updated_by": {
      "type": "string",
      "enum": ["agent", "user"],
      "description": "Who made the last update (affects state transitions)"
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time"
    },
    "requirements": {
      "type": "object",
      "description": "Requirements metadata",
      "properties": {
        "count": {
          "type": "integer",
          "minimum": 0
        },
        "source": {
          "type": "string",
          "enum": ["prd", "pm-interview", "manual"],
          "description": "Where requirements came from"
        }
      }
    },
    "atomic_specs": {
      "type": "object",
      "description": "Atomic specs metadata",
      "properties": {
        "count": {
          "type": "integer",
          "minimum": 0
        },
        "coverage": {
          "type": "string",
          "description": "Percentage of requirements covered by atomic specs"
        },
        "enforcement_status": {
          "type": "string",
          "enum": ["not_run", "passing", "failing", "warnings"],
          "description": "Last atomicity enforcement result"
        },
        "last_enforced": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "convergence": {
      "type": "object",
      "description": "Convergence gate status",
      "properties": {
        "spec_complete": { "type": "boolean" },
        "all_acs_implemented": { "type": "boolean" },
        "all_tests_passing": { "type": "boolean" },
        "unifier_passed": { "type": "boolean" },
        "code_review_passed": { "type": "boolean" },
        "security_review_passed": { "type": "boolean" },
        "browser_tests_passed": {
          "type": ["boolean", "null"],
          "description": "null if not applicable"
        },
        "docs_generated": {
          "type": ["boolean", "null"],
          "description": "null if not applicable"
        }
      }
    },
    "decision_log": {
      "type": "array",
      "description": "Timestamped log of state changes and decisions",
      "items": {
        "type": "object",
        "properties": {
          "timestamp": { "type": "string", "format": "date-time" },
          "actor": {
            "type": "string",
            "enum": [
              "user",
              "agent",
              "atomizer",
              "implementer",
              "unifier",
              "enforcer",
              "test-writer",
              "refactorer",
              "code-reviewer",
              "security-reviewer",
              "facilitator"
            ]
          },
          "action": { "type": "string" },
          "details": { "type": "string" }
        },
        "required": ["timestamp", "actor", "action"]
      }
    },
    "last_progress_update": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO timestamp of last progress update. Used by heartbeat system to detect stale work."
    },
    "heartbeat_warnings": {
      "type": "integer",
      "minimum": 0,
      "default": 0,
      "description": "Count of consecutive heartbeat warnings issued. Resets to 0 when progress is logged."
    },
    "session_ref": {
      "type": ["object", "null"],
      "description": "Cross-session persistence reference for recovery",
      "properties": {
        "session_id": {
          "type": "string",
          "description": "UUID of the session that last worked on this spec group"
        },
        "last_checkpoint": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of last persisted checkpoint"
        },
        "last_atomic_spec": {
          "type": "string",
          "pattern": "^as-[0-9]{3}(-[a-z0-9-]+)?$",
          "description": "ID of the last completed atomic spec"
        },
        "checkpoint_phase": {
          "type": "string",
          "enum": [
            "pm_interview",
            "spec_authoring",
            "atomizing",
            "enforcing",
            "investigating",
            "awaiting_approval",
            "implementing",
            "testing",
            "verifying",
            "reviewing",
            "complete"
          ],
          "description": "Phase at last checkpoint"
        },
        "checkpoint_state": {
          "type": "string",
          "enum": ["clean", "in_progress", "interrupted"],
          "description": "State at checkpoint: clean=between phases, in_progress=mid-work, interrupted=abnormal termination"
        }
      }
    },
    "last_session_id": {
      "type": ["string", "null"],
      "description": "UUID of the last session that modified this spec group"
    }
  }
}
