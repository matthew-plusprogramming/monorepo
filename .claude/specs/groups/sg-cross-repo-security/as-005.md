---
id: as-005-concurrency-limiter
title: Concurrency Limiter for Subprocess Spawning
date: 2026-02-20
status: pending
requirements_refs:
  - REQ-005
parent_spec_section: "AS-005: Concurrency Limiter for Subprocess Spawning"
---

# AS-005: Concurrency Limiter for Subprocess Spawning

## Description

Create a `ProcessConcurrencyLimiter` class that bounds concurrent subprocess spawning with `acquire()` / `release()` semaphore methods. Waiters are queued in FIFO order. A timeout parameter on `acquire()` prevents deadlocks. All subprocess spawning call sites are wrapped with acquire/release in a try/finally pattern.

## Context

The monorepo spawns child processes in several scripts:

1. `cdk/platform-cdk/scripts/cdk-bootstrap-migrate.ts` -- `execSync()` for tofu migrations (synchronous, inherently sequential)
2. `cdk/platform-cdk/scripts/cdk-output.ts` -- `execSync()` for CDK output retrieval (synchronous, inherently sequential)
3. `cdk/platform-cdk/scripts/copy-lambda-artifacts.ts` -- `spawnSync()` for zip creation (synchronous, inherently sequential)
4. `apps/node-server/scripts/bundle-argon-2.ts` -- `child_process` usage (async subprocess calls)

Currently there is no concurrency control. The CDK scripts (1-3) use synchronous calls (`execSync`/`spawnSync`) and are inherently sequential -- they do NOT need wrapping with the concurrency limiter. The concurrency limiter wraps only async subprocess calls, currently only `bundle-argon-2.ts`. The real value comes when async subprocess spawning is added in the future. This spec adds proactive protection.

**ai-eng-dashboard commit**: `1ac0139`

## Goal

Prevent OS resource exhaustion from unbounded subprocess spawning by adding a configurable concurrency limiter with FIFO fairness and timeout protection.

## Requirements

See `requirements.md` REQ-005.

- **WHEN** code needs to spawn a subprocess
- **THEN** the system shall acquire a slot from `ProcessConcurrencyLimiter` before spawning
- **AND** release the slot after the subprocess completes

- **WHEN** all concurrency slots are in use
- **THEN** `acquire()` shall return a promise that resolves when a slot is available
- **AND** waiters shall be served in FIFO order

- **WHEN** a configurable timeout elapses while waiting for a slot
- **THEN** `acquire()` shall reject with a timeout error

- **WHEN** the concurrency limit needs to be configured
- **THEN** the system shall read from `MAX_CONCURRENT_PROCESSES` env var with default 5

## Acceptance Criteria

| ID    | Criterion | Testable |
| ----- | --------- | -------- |
| AC5.1 | `ProcessConcurrencyLimiter` class exists with `acquire()` and `release()` methods | true |
| AC5.2 | Default max concurrency is 5, configurable via `MAX_CONCURRENT_PROCESSES` env var | true |
| AC5.3 | `acquire()` returns a Promise that resolves when a slot is available; queues if full | true |
| AC5.4 | `release()` frees a slot and dequeues the next waiter in FIFO order | true |
| AC5.5 | `acquire(timeoutMs)` rejects with a timeout error after the specified duration if no slot is available | true |
| AC5.6 | Async subprocess spawning call sites (currently only `bundle-argon-2.ts`) wrap spawn/exec in acquire/release with try/finally. Synchronous CDK scripts (`cdk-bootstrap-migrate.ts`, `cdk-output.ts`, `copy-lambda-artifacts.ts`) do NOT need wrapping since they are inherently sequential. | true |
| AC5.7 | `_resetForTest()` method clears internal state (active count, queue) for test isolation | true |
| AC5.8 | Queue fairness: waiters served in FIFO order (first acquire call resolved first) | true |

## Task List

- [ ] T5.1: Create `ProcessConcurrencyLimiter` class with `acquire()`, `release()`, `_resetForTest()` methods (AC5.1, AC5.3, AC5.4, AC5.7)
  - Dependencies: none
  - Outcome: Class exists with core semaphore behavior and FIFO queue
- [ ] T5.2: Add configurable max concurrency via `MAX_CONCURRENT_PROCESSES` env var with default 5 (AC5.2)
  - Dependencies: T5.1
  - Outcome: Constructor reads env var, falls back to 5
- [ ] T5.3: Implement timeout parameter on `acquire()` that rejects after N ms (AC5.5)
  - Dependencies: T5.1
  - Outcome: Timed-out waiters are removed from queue and rejected
- [ ] T5.4: Verify FIFO queue ordering with multi-waiter test (AC5.8)
  - Dependencies: T5.1
  - Outcome: Test confirms first waiter resolves before second waiter
- [ ] T5.5: Wrap async subprocess call sites with acquire/release in try/finally -- currently only `bundle-argon-2.ts` (AC5.6)
  - Dependencies: T5.1
  - Outcome: Async subprocess calls in `bundle-argon-2.ts` bounded by limiter. Synchronous CDK scripts (`cdk-bootstrap-migrate.ts`, `cdk-output.ts`, `copy-lambda-artifacts.ts`) are inherently sequential and do NOT need wrapping.
- [ ] T5.6: Write comprehensive unit tests for limiter (AC5.1-AC5.8)
  - Dependencies: T5.1, T5.2, T5.3
  - Outcome: Tests cover: basic acquire/release, full queue blocking, timeout rejection, FIFO ordering, reset

## Evidence Table

| AC    | Implementation File | Test File | Status |
| ----- | ------------------- | --------- | ------ |
| AC5.1 | Shared utility location TBD | TBD | pending |
| AC5.2 | Shared utility location TBD | TBD | pending |
| AC5.3 | Shared utility location TBD | TBD | pending |
| AC5.4 | Shared utility location TBD | TBD | pending |
| AC5.5 | Shared utility location TBD | TBD | pending |
| AC5.6 | All scripts with child_process usage | TBD | pending |
| AC5.7 | Shared utility location TBD | TBD | pending |
| AC5.8 | Shared utility location TBD | TBD | pending |

## Test Strategy

Test in isolation by:
1. Unit test: acquire when slots available returns immediately (resolved promise)
2. Unit test: acquire when all slots full returns pending promise
3. Unit test: release when queue has waiters resolves next waiter
4. Unit test: release when queue empty decrements active count
5. Unit test: acquire with timeout rejects after N ms; verify waiter removed from queue
6. Unit test: FIFO ordering -- acquire 3 waiters, release 3 slots, verify resolution order matches enqueue order
7. Unit test: `_resetForTest()` clears active count to 0 and empties queue
8. Unit test: configurable max concurrency via constructor parameter and env var

## Deployment Notes

The concurrency limiter wraps only async subprocess calls (currently only `bundle-argon-2.ts`). Synchronous CDK scripts (`cdk-bootstrap-migrate.ts`, `cdk-output.ts`, `copy-lambda-artifacts.ts`) use `execSync`/`spawnSync` and are inherently sequential -- they do not need wrapping. The real value of the limiter comes when additional async subprocess spawning is added in the future.

## Rollback Strategy

Remove acquire/release wrapping from call sites. The `ProcessConcurrencyLimiter` class can remain unused. No data migration required.

## Atomicity Justification

| Criterion | Justification |
| --------- | ------------- |
| independently_testable | The limiter is a standalone class testable with async/await test patterns. No external dependencies. |
| independently_deployable | The limiter is additive infrastructure. Wrapping call sites is optional and incremental. |
| independently_reviewable | One class file plus call site updates -- focused review scope. |
| independently_reversible | Removing acquire/release wrapping restores original behavior. The class itself is inert if unused. |
