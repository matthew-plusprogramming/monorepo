---
id: as-001-mask-error-messages
title: Mask Internal Error Messages in API Responses
date: 2026-02-20
status: pending
requirements_refs:
  - REQ-001
parent_spec_section: "AS-001: Mask Internal Error Messages in API Responses"
---

# AS-001: Mask Internal Error Messages in API Responses

## Description

Replace raw `error.message` values in HTTP error responses with generic messages. The `generateRequestHandler` fallback on line 73 of `request.handler.ts` sends `error.message` directly to clients. All handler `InternalServerError` mapper functions pass `e.message` through, leaking internal details. Additionally, `GitHubApiError` (502) and `GitHubAuthError` (401) mappers in `githubIssues.handler.ts` and `githubPRs.handler.ts` leak `e.message` as internal API errors that should be masked. This spec covers masking all internal error messages while preserving user-facing 4xx messages.

## Context

The `generateRequestHandler` in `packages/core/backend-core/src/request.handler.ts` (line 73) sends `error.message` directly to HTTP clients when no error type matches. Additionally, all handler `InternalServerError` mapper functions pass `e.message` through, leaking internal details like "Failed to verify password: SCRAM authentication failed" or "Failed to hash password: memory allocation error". This exposes internal implementation details (stack traces, DB errors, file paths) that aid attackers in reconnaissance.

Furthermore, `githubIssues.handler.ts` and `githubPRs.handler.ts` have `GitHubApiError` (502) and `GitHubAuthError` (401) mappers that leak `e.message`. These are internal API errors (e.g., upstream GitHub API failures), not user-facing messages, and must be masked. Note that the ~20+ mapper instances span 13 handler files -- the count refers to handler files, not individual mapper entries.

**Error types requiring masking**:
- `InternalServerError` (500) -- all handlers
- `GitHubApiError` (502) -- `githubIssues.handler.ts`, `githubPRs.handler.ts`
- `GitHubAuthError` (401) -- `githubIssues.handler.ts`, `githubPRs.handler.ts`

**Error types that remain user-facing** (NOT masked):
- `ZodError` (400) -- validation feedback
- `NotFound` (404) -- resource not found
- `Conflict` (409) -- state conflicts
- `InvalidCredentials` (401 from login/register) -- auth feedback

**ai-eng-dashboard commit**: `7de0eb9`

## Goal

Replace raw `error.message` values in HTTP error responses with generic messages, including `GitHubApiError` and `GitHubAuthError` mappers. Log the real error server-side. Preserve user-facing 4xx error messages (ZodError, NotFound, Conflict, InvalidCredentials).

## Requirements

See `requirements.md` REQ-001.

- **WHEN** a handler catches an exception and returns an HTTP 500 response
- **THEN** the system shall return a generic message such as "Internal server error"
- **AND** the system shall NOT include the raw `error.message` from the caught exception
- **AND** the system shall log the real error via `console.error`

- **WHEN** the `generateRequestHandler` fallback error handler is invoked (no matching error type)
- **THEN** the system shall return `"Internal server error"` instead of `error.message`

- **WHEN** a handler maps `GitHubApiError` or `GitHubAuthError` to an HTTP response
- **THEN** the system shall return a generic message (not `e.message`)
- **AND** the real error shall be logged server-side

## Acceptance Criteria

| ID    | Criterion | Testable |
| ----- | --------- | -------- |
| AC1.1 | The `generateRequestHandler` fallback (line 73 of `request.handler.ts`) returns the string `"Internal server error"` instead of `error.message` | true |
| AC1.2 | The fallback path logs the real `error.message` and `error.cause` via `console.error` before sending the generic response | true |
| AC1.3 | All `InternalServerError` mapper functions in handler `statusCodesToErrors` return a generic message object `{ error: "Internal server error" }` (not `e.message`) | true |
| AC1.4 | All 13 handler files are updated: `login.handler.ts`, `register.handler.ts`, `dashboardLogin.handler.ts`, `agentTaskStatus.handler.ts`, `specGroups.handler.ts`, `getUser.handler.ts`, `heartbeat.handler.ts`, `health.handler.ts`, `projects.handler.ts`, `agentDispatch.handler.ts`, `githubIssues.handler.ts`, `githubPRs.handler.ts`, `dashboardLogout.handler.ts` (~20+ mapper instances across these files) | true |
| AC1.5 | `GitHubApiError` (502) and `GitHubAuthError` (401) mappers in `githubIssues.handler.ts` and `githubPRs.handler.ts` return generic messages (these are internal API errors, not user-facing) | true |
| AC1.6 | 400-level error mappers (ZodError, NotFound, Conflict, InvalidCredentials) continue returning user-facing messages and are NOT changed to generic messages | true |

## Task List

- [ ] T1.1: Update `generateRequestHandler` fallback (line 73 of `packages/core/backend-core/src/request.handler.ts`) to log real error and return generic message (AC1.1, AC1.2)
  - Dependencies: none
  - Outcome: Fallback sends `"Internal server error"`, logs real error
- [ ] T1.2: Update `InternalServerError` mapper in `apps/node-server/src/handlers/login.handler.ts` (AC1.3, AC1.4)
  - Dependencies: none
  - Outcome: Mapper returns `{ error: "Internal server error" }` instead of `e.message`
- [ ] T1.3: Update `InternalServerError` mapper in `apps/node-server/src/handlers/register.handler.ts` (AC1.3, AC1.4)
  - Dependencies: none
  - Outcome: Mapper returns generic message
- [ ] T1.4: Update `InternalServerError` mapper in `apps/node-server/src/handlers/dashboardLogin.handler.ts` (AC1.3, AC1.4)
  - Dependencies: none
  - Outcome: Mapper returns generic message
- [ ] T1.5: Audit and update `InternalServerError` mappers in all remaining 9 handler files, plus `GitHubApiError`/`GitHubAuthError` mappers in `githubIssues.handler.ts` and `githubPRs.handler.ts` (AC1.3, AC1.4, AC1.5, AC1.6)
  - Dependencies: none
  - Outcome: All 13 handlers use generic InternalServerError messages; GitHubApiError/GitHubAuthError masked; 4xx mappers unchanged

## Evidence Table

| AC    | Implementation File | Test File | Status |
| ----- | ------------------- | --------- | ------ |
| AC1.1 | `packages/core/backend-core/src/request.handler.ts` | TBD | pending |
| AC1.2 | `packages/core/backend-core/src/request.handler.ts` | TBD | pending |
| AC1.3 | All 13 handler files in `apps/node-server/src/handlers/` | TBD | pending |
| AC1.4 | All 13 handler files in `apps/node-server/src/handlers/` | TBD | pending |
| AC1.5 | `apps/node-server/src/handlers/githubIssues.handler.ts`, `githubPRs.handler.ts` | TBD | pending |
| AC1.6 | All 13 handler files in `apps/node-server/src/handlers/` | TBD | pending |

## Test Strategy

Test in isolation by:
1. Unit testing `generateRequestHandler` with a mock handler that throws an unmatched error -- verify response is `"Internal server error"` and `console.error` was called
2. Unit testing each handler's `statusCodesToErrors` mapper for `InternalServerError` returns generic message
3. Unit testing `GitHubApiError` and `GitHubAuthError` mappers return generic messages (not `e.message`)
4. Unit testing 4xx mappers still return their original user-facing messages (ZodError, NotFound, Conflict, InvalidCredentials)

## Deployment Notes

This is a behavior change for API error responses. Any API clients relying on specific error message text for InternalServerError responses will see `"Internal server error"` instead. 4xx responses are unchanged.

## Rollback Strategy

Revert the `request.handler.ts` fallback change and handler mapper changes. No data migration required.

## Atomicity Justification

| Criterion | Justification |
| --------- | ------------- |
| independently_testable | Each handler's mapper can be tested in isolation. The fallback handler is testable independently. |
| independently_deployable | Error masking is a self-contained change to response formatting with no external dependencies. |
| independently_reviewable | All changes follow the same pattern (replace `e.message` with generic string) and can be reviewed as a cohesive unit. |
| independently_reversible | Reverting restores original `e.message` passthrough behavior. No data or schema changes involved. |
