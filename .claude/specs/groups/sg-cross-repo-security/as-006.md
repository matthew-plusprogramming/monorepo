---
id: as-006-zod-body-validation-audit
title: Zod Body Validation Audit on POST Endpoints
date: 2026-02-23
status: pending
requirements_refs:
  - REQ-004
parent_spec_section: "AS-006: Zod Body Validation Audit on POST Endpoints"
---

# AS-006: Zod Body Validation Audit on POST Endpoints

## Description

Audit all POST/PUT/PATCH endpoints for Zod request body validation and add Zod schemas to any endpoints missing them. Most handlers already use the `parseInput()` helper (which calls `.parse()`), but this spec ensures complete coverage and consistent error response formatting.

## Context

The codebase has a mixed validation posture for request bodies:

**Already validated (via `parseInput()` helper)**:
- `login.handler.ts` -- uses `LoginInputSchema`
- `register.handler.ts` -- uses `RegisterInputSchema`
- `dashboardLogin.handler.ts` -- uses `DashboardLoginInputSchema`
- `agentTaskStatus.handler.ts` -- uses `AgentTaskStatusUpdateInputSchema`
- `specGroups.handler.ts` -- uses `TransitionInputSchema` and `UpdateFlagsInputSchema`
- `agentDispatch.handler.ts` -- uses parseInput for body

All identified POST/PUT/PATCH handlers currently have Zod validation via `parseInput()`. This spec formalizes the audit to confirm complete coverage, ensures no endpoints are missed, and verifies that validation error responses consistently return structured field-level messages without internal details.

**ai-eng-dashboard commit**: `7de0eb9`

## Goal

Confirm that every POST/PUT/PATCH handler validates its request body with a Zod schema and that validation errors return structured, user-safe messages.

## Requirements

See `requirements.md` REQ-004.

- **WHEN** a POST, PUT, or PATCH request is received
- **THEN** the system shall validate `req.body` against a Zod schema before processing

- **WHEN** request body validation fails
- **THEN** the system shall return HTTP 400 with structured field-level error messages
- **AND** the response shall NOT include internal details (stack traces, file paths, etc.)

## Acceptance Criteria

| ID    | Criterion | Testable |
| ----- | --------- | -------- |
| AC6.1 | Every POST/PUT/PATCH handler in `apps/node-server/src/` has a Zod schema for request body validation | true |
| AC6.2 | Request bodies are validated before processing (existing `parseInput()` usage counts as validated) | true |
| AC6.3 | Failed validation returns HTTP 400 with structured field-level error messages (no internal details) | true |

## Task List

- [ ] T6.1: Audit all POST/PUT/PATCH handlers for Zod body validation completeness (AC6.1, AC6.2)
  - Dependencies: none
  - Outcome: Audit report confirming all handlers have Zod schemas; any gaps identified and documented
- [ ] T6.2: Add Zod schema validation to any POST endpoint found missing it during audit (AC6.1, AC6.3)
  - Dependencies: T6.1
  - Outcome: All POST/PUT/PATCH endpoints have Zod validation
- [ ] T6.3: Verify all validation error responses return structured field-level messages without internal details (AC6.3)
  - Dependencies: T6.1
  - Outcome: Confirmed all ZodError mappers return sanitized field-level errors

## Evidence Table

| AC    | Implementation File | Test File | Status |
| ----- | ------------------- | --------- | ------ |
| AC6.1 | All handler files in `apps/node-server/src/handlers/` | TBD | pending |
| AC6.2 | All handler files in `apps/node-server/src/handlers/` | TBD | pending |
| AC6.3 | All handler files in `apps/node-server/src/handlers/` | TBD | pending |

## Test Strategy

Test in isolation by:
1. Unit testing each handler's body validation returns structured 400 on invalid input
2. Unit testing that ZodError mapper output contains field-level error details but no internal information
3. Code review confirming all POST/PUT/PATCH handlers use `parseInput()` or equivalent Zod validation
4. Negative testing: send malformed bodies to each endpoint and verify 400 response format

## Deployment Notes

This is primarily an audit spec. If all handlers already have Zod validation (as the current codebase analysis suggests), no behavioral changes occur. If gaps are found and schemas are added, those endpoints will start returning 400 for previously-accepted invalid input.

## Rollback Strategy

Revert any newly added Zod schemas. Existing `parseInput()` usage remains unchanged. No data migration required.

## Atomicity Justification

| Criterion | Justification |
| --------- | ------------- |
| independently_testable | Each handler's Zod validation can be tested in isolation with mock request bodies. |
| independently_deployable | Body validation is self-contained within each handler with no cross-spec dependencies. |
| independently_reviewable | Audit results and any new schemas can be reviewed as a cohesive validation unit. |
| independently_reversible | Reverting new schemas restores original behavior. Existing parseInput usage is unchanged. |
