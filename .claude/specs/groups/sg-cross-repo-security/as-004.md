---
id: as-004-route-param-validation
title: Route Parameter Validation Middleware
date: 2026-02-20
status: pending
requirements_refs:
  - REQ-004
parent_spec_section: "AS-004: Route Parameter Validation Middleware"
---

# AS-004: Route Parameter Validation Middleware

## Description

Create a shared `validateRouteParam()` middleware to enforce regex-based format constraints on route parameters containing user-supplied IDs. Route parameters like `:id` are currently used as `req.params.id as string` without any validation, allowing special characters that could cause unexpected behavior in downstream operations (e.g., DynamoDB queries).

## Context

The codebase uses route parameters extensively but performs no format validation on them:

- `specGroups.handler.ts` line 77: `const id = req.params.id as string` -- no format validation
- `agentTaskStatus.handler.ts` line 61: `const taskId = req.params.id as string` -- no format validation
- `getUser.handler.ts`: `req.params.identifier` -- no format validation (note: handler already has Zod validation via `GetUserSchema` at the handler level, but route-level middleware adds defense-in-depth)
- `projects.handler.ts`: `req.params.id` -- no format validation
- All `:id` route parameters across 10+ routes in `index.ts`

Route parameters containing special characters could cause unexpected behavior in DynamoDB queries or other downstream operations.

**ai-eng-dashboard commit**: `7de0eb9`

## Goal

Ensure every route parameter containing user-supplied IDs is validated with a regex pattern before reaching business logic, providing defense-in-depth even where handler-level validation exists.

## Requirements

See `requirements.md` REQ-004.

- **WHEN** a route parameter contains a user-supplied ID
- **THEN** the system shall validate the parameter against a regex pattern (`/^[a-zA-Z0-9_:-]{1,128}$/` by default)
- **AND** invalid parameters shall be rejected with HTTP 400 before reaching handler logic

- **WHEN** route parameter validation is needed
- **THEN** a shared `validateRouteParam(paramName, regex)` middleware shall be available

## Acceptance Criteria

| ID    | Criterion | Testable |
| ----- | --------- | -------- |
| AC4.1 | Route parameters containing user-supplied IDs are validated with `/^[a-zA-Z0-9_:-]{1,128}$/` or equivalent | true |
| AC4.2 | A shared `validateRouteParam(paramName, regex)` middleware or utility exists at `apps/node-server/src/middleware/validateRouteParam.middleware.ts` | true |
| AC4.3 | Route parameter validation is in place for all routes: `/api/spec-groups/:id`, `/api/spec-groups/:id/transition`, `/api/spec-groups/:id/flags`, `/api/agent-tasks/:id`, `/api/agent-tasks/:id/status`, `/api/agent-tasks/:id/logs`, `/api/projects/:id`, `/api/projects/:id/github/issues`, `/api/projects/:id/github/pulls`, `/user/:identifier` | true |

## Task List

- [ ] T4.1: Create `validateRouteParam()` shared middleware at `apps/node-server/src/middleware/validateRouteParam.middleware.ts` with configurable regex (AC4.2)
  - Dependencies: none
  - Outcome: Middleware rejects invalid params with 400 before handler executes
- [ ] T4.2: Add `validateRouteParam('id')` to all `:id` routes in `apps/node-server/src/index.ts` (AC4.1, AC4.3)
  - Dependencies: T4.1
  - Outcome: All 9 routes with `:id` have param validation
- [ ] T4.3: Add `validateRouteParam('identifier')` to `/user/:identifier` route (AC4.1, AC4.3)
  - Dependencies: T4.1
  - Outcome: Identifier parameter validated before reaching getUser handler

## Evidence Table

| AC    | Implementation File | Test File | Status |
| ----- | ------------------- | --------- | ------ |
| AC4.1 | `apps/node-server/src/middleware/validateRouteParam.middleware.ts`, `apps/node-server/src/index.ts` | TBD | pending |
| AC4.2 | `apps/node-server/src/middleware/validateRouteParam.middleware.ts` | TBD | pending |
| AC4.3 | `apps/node-server/src/index.ts` | TBD | pending |

## Test Strategy

Test in isolation by:
1. Unit testing `validateRouteParam()` middleware with valid IDs (alphanumeric, hyphens, underscores, colons) -- verify next() called
2. Unit testing `validateRouteParam()` with invalid IDs (slashes, dots, SQL injection attempts, oversized strings > 128 chars) -- verify 400 response
3. Unit testing custom regex override works correctly
4. Integration testing that invalid route params on real routes return 400 before reaching handler
5. Code review confirming all routes in `index.ts` have param validation middleware

## Deployment Notes

Adding route parameter validation may reject requests with unusual ID formats. Current IDs in the system use UUID format (alphanumeric with hyphens) which passes the regex. The 128-character limit provides generous headroom. Note that `getUser.handler.ts` already has handler-level Zod validation via `GetUserSchema`, so the route-level middleware is defense-in-depth. Monitor 400 responses after deployment.

## Rollback Strategy

Remove `validateRouteParam()` middleware from routes in `index.ts`. The middleware module can remain unused. No data migration required.

## Atomicity Justification

| Criterion | Justification |
| --------- | ------------- |
| independently_testable | `validateRouteParam()` middleware is testable with mock request objects. Each route can be tested independently. |
| independently_deployable | Route parameter validation is additive middleware with no dependencies on other specs. |
| independently_reviewable | Changes are in one middleware file and route registration in `index.ts` -- a focused review scope. |
| independently_reversible | Removing middleware from route chain restores original behavior. No data or schema changes. |
