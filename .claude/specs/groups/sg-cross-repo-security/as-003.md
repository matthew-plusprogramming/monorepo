---
id: as-003-child-env-allowlist
title: Minimal Environment Allowlist for Child Processes
date: 2026-02-20
status: pending
requirements_refs:
  - REQ-003
parent_spec_section: "AS-003: Minimal Env Allowlist for Child Processes"
---

# AS-003: Minimal Environment Allowlist for Child Processes

## Description

Create a `buildChildEnv()` utility at `scripts/utils/child-env.mjs` (plain ESM, importable from both `apps/` and `cdk/`) that constructs a minimal environment for child processes, replacing full `process.env` inheritance. The utility uses a default allowlist of safe variables plus pattern matching for `CLAUDE_*` and `ANTHROPIC_*` prefixes, with per-callsite additional keys.

## Context

Scripts in the monorepo spawn child processes with the full parent environment:

1. `cdk/platform-cdk/scripts/cdk-bootstrap-migrate.ts` (line 34): `execSync(..., { env: process.env })`
2. `cdk/platform-cdk/scripts/cdk-output.ts` (line 13): `execSync('npm run cdk:output', { stdio: 'inherit', env: process.env })`
3. `cdk/platform-cdk/scripts/copy-lambda-artifacts.ts` (line 120): `spawnSync('zip', [...], { cwd: sourceDir, stdio: 'ignore' })` -- uses default env (inherits all)
4. `apps/node-server/scripts/bundle-argon-2.ts` (lines 31, 56): Two `child_process` calls with `env: { ...process.env }` -- full environment spread

Full environment inheritance leaks secrets (JWT_SECRET, PEPPER, WEBHOOK_SECRET, PASSWORD_HASH, SESSION_SECRET), API keys, and internal configuration to subprocesses that do not need them.

**ai-eng-dashboard commit**: `1ac0139`

## Goal

Prevent secret leakage to child processes by providing only the environment variables each subprocess needs.

## Requirements

See `requirements.md` REQ-003.

- **WHEN** the system spawns a child process via `spawn()`, `exec()`, `execSync()`, or `fork()`
- **THEN** the system shall use `buildChildEnv()` to construct a minimal environment

- **WHEN** `buildChildEnv()` is called
- **THEN** the default allowlist shall include: PATH, HOME, USER, SHELL, TERM, NODE_ENV, LOG_LEVEL
- **AND** all `CLAUDE_*` and `ANTHROPIC_*` variables shall be included
- **AND** additional variable names can be passed per-callsite

- **WHEN** a requested additional key is not present in `process.env`
- **THEN** the system shall log a warning

## Acceptance Criteria

| ID    | Criterion | Testable |
| ----- | --------- | -------- |
| AC3.1 | A `buildChildEnv(additionalKeys?: string[])` function exists at `scripts/utils/child-env.mjs` (plain ESM, importable from both `apps/` and `cdk/`) | true |
| AC3.2 | Default allowlist includes: `PATH`, `HOME`, `USER`, `SHELL`, `TERM`, `NODE_ENV`, `LOG_LEVEL` | true |
| AC3.3 | All env vars matching `CLAUDE_*` and `ANTHROPIC_*` patterns are automatically included | true |
| AC3.4 | Additional keys can be passed per-callsite and are merged into the allowlist | true |
| AC3.5 | The function logs a warning when a requested additional key is not present in `process.env` | true |
| AC3.6 | `cdk/platform-cdk/scripts/cdk-bootstrap-migrate.ts` uses `buildChildEnv()` instead of `process.env` | true |
| AC3.7 | `cdk/platform-cdk/scripts/cdk-output.ts` uses `buildChildEnv()` instead of `process.env` | true |
| AC3.8 | `cdk/platform-cdk/scripts/copy-lambda-artifacts.ts` uses `buildChildEnv()` for any `spawnSync` calls | true |
| AC3.9 | `apps/node-server/scripts/bundle-argon-2.ts` uses `buildChildEnv()` instead of `{ ...process.env }` at both child_process callsites (lines 31 and 56) | true |

## Task List

- [ ] T3.1: Create `buildChildEnv()` utility function with default allowlist at `scripts/utils/child-env.mjs` (plain ESM) (AC3.1, AC3.2)
  - Dependencies: none
  - Outcome: Utility function exists at `scripts/utils/child-env.mjs` and is importable from both `apps/` and `cdk/` packages
- [ ] T3.2: Add `CLAUDE_*` and `ANTHROPIC_*` pattern matching to `buildChildEnv()` (AC3.3)
  - Dependencies: T3.1
  - Outcome: Pattern-matched env vars are included in output
- [ ] T3.3: Add `additionalKeys` parameter support with missing-key warnings (AC3.4, AC3.5)
  - Dependencies: T3.1
  - Outcome: Additional keys merged; missing keys produce console.warn
- [ ] T3.4: Update `cdk/platform-cdk/scripts/cdk-bootstrap-migrate.ts` to use `buildChildEnv()` (AC3.6)
  - Dependencies: T3.1
  - Outcome: Script passes minimal env to execSync, with `ENV` and CDK-specific vars as additionalKeys
- [ ] T3.5: Update `cdk/platform-cdk/scripts/cdk-output.ts` to use `buildChildEnv()` (AC3.7)
  - Dependencies: T3.1
  - Outcome: Script passes minimal env to execSync, with `STACK` as additionalKey
- [ ] T3.6: Audit and update `cdk/platform-cdk/scripts/copy-lambda-artifacts.ts` for `buildChildEnv()` usage (AC3.8)
  - Dependencies: T3.1
  - Outcome: Any spawnSync calls use buildChildEnv instead of default env
- [ ] T3.7: Update `apps/node-server/scripts/bundle-argon-2.ts` to use `buildChildEnv()` at both child_process callsites (lines 31 and 56) (AC3.9)
  - Dependencies: T3.1
  - Outcome: Both `env: { ...process.env }` replaced with `env: buildChildEnv(['NODE_ENV', ...])` with appropriate additional keys

## Evidence Table

| AC    | Implementation File | Test File | Status |
| ----- | ------------------- | --------- | ------ |
| AC3.1 | `scripts/utils/child-env.mjs` | TBD | pending |
| AC3.2 | `scripts/utils/child-env.mjs` | TBD | pending |
| AC3.3 | `scripts/utils/child-env.mjs` | TBD | pending |
| AC3.4 | `scripts/utils/child-env.mjs` | TBD | pending |
| AC3.5 | `scripts/utils/child-env.mjs` | TBD | pending |
| AC3.6 | `cdk/platform-cdk/scripts/cdk-bootstrap-migrate.ts` | TBD | pending |
| AC3.7 | `cdk/platform-cdk/scripts/cdk-output.ts` | TBD | pending |
| AC3.8 | `cdk/platform-cdk/scripts/copy-lambda-artifacts.ts` | TBD | pending |
| AC3.9 | `apps/node-server/scripts/bundle-argon-2.ts` | TBD | pending |

## Test Strategy

Test in isolation by:
1. Unit testing `buildChildEnv()` with a controlled `process.env` -- verify only allowlisted keys appear in output
2. Unit testing that `CLAUDE_API_KEY` and `ANTHROPIC_API_KEY` are included when present
3. Unit testing that `JWT_SECRET`, `PEPPER`, `WEBHOOK_SECRET` are NOT included
4. Unit testing `additionalKeys` parameter merges correctly
5. Unit testing that missing additional keys produce `console.warn`
6. Code review verifying all four scripts updated (3 CDK scripts + bundle-argon-2.ts)

## Deployment Notes

Scripts will receive fewer environment variables than before. Ensure all variables needed by child commands (e.g., `tofu`, `npm`, `zip`, argon2 build tools) are either in the default allowlist (PATH, HOME) or passed as additional keys. The CDK scripts need `ENV`, `STACK`, and possibly AWS credential variables. The `bundle-argon-2.ts` script may need build-related env vars as additional keys.

## Rollback Strategy

Revert the callsite changes to restore `env: process.env`. The `buildChildEnv()` utility can remain unused. No data migration required.

## Atomicity Justification

| Criterion | Justification |
| --------- | ------------- |
| independently_testable | `buildChildEnv()` is a pure function testable with controlled process.env. |
| independently_deployable | Utility creation and callsite updates are self-contained with no cross-spec dependencies. |
| independently_reviewable | Changes span one utility file and four script files -- a focused review scope. |
| independently_reversible | Reverting callsite changes restores full env inheritance. The utility itself is harmless if unused. |
