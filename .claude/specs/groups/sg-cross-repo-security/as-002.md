---
id: as-002-payload-size-guard
title: Payload Size Guard Before HMAC Verification
date: 2026-02-20
status: pending
requirements_refs:
  - REQ-002
parent_spec_section: "AS-002: Payload Size Guard Before HMAC Verification"
---

# AS-002: Payload Size Guard Before HMAC Verification

## Description

Add a Content-Length / body size check before HMAC signature verification on webhook routes, and add capacity bounds to in-memory rate limiting collections. The current `webhookAuthMiddleware` in `apps/node-server/src/middleware/webhookAuth.middleware.ts` performs HMAC computation on the full request body without any size check, allowing CPU-based denial-of-service via oversized payloads. Additionally, in-memory collections in `dashboardRateLimiting.middleware.ts` can grow unbounded, creating a memory exhaustion vector. Note: `ipRateLimiting.middleware.ts` uses DynamoDB (not in-memory), so only `dashboardRateLimiting.middleware.ts` needs capacity bounds.

## Context

The `webhookAuthMiddleware` at `apps/node-server/src/middleware/webhookAuth.middleware.ts` calls `JSON.stringify(req.body)` on line 105 and then passes the result to `validateWebhookSignature()` which computes HMAC-SHA256. Express `json()` middleware (line 100 of `index.ts`) parses the body before the webhook middleware runs, with no configured size limit. An attacker can send a multi-GB payload, forcing expensive JSON parsing and HMAC computation.

The webhook endpoint is `POST /api/agent-tasks/:id/status` (line 188 of `index.ts`), protected by `webhookAuthMiddleware`.

**ai-eng-dashboard commit**: `939099f`

## Goal

Prevent CPU-based denial-of-service by rejecting oversized payloads before HMAC verification. Make the payload size limit configurable via environment variable. Add capacity bounds to in-memory rate limiting collections to prevent memory exhaustion.

## Requirements

See `requirements.md` REQ-002.

- **WHEN** a webhook request arrives at an HMAC-authenticated endpoint
- **THEN** the system shall check the Content-Length header before reading the body
- **AND** requests exceeding the maximum size shall be rejected with HTTP 413 before HMAC verification

- **WHEN** a webhook request arrives without a Content-Length header
- **THEN** the system shall read the body with a streaming size limit

- **WHEN** the maximum payload size needs to be configured
- **THEN** the system shall read from `MAX_WEBHOOK_PAYLOAD_BYTES` environment variable with 1MB default

- **WHEN** in-memory collections are used in rate limiting middleware
- **THEN** the system shall enforce capacity bounds (MAX_EVENTS, MAX_ENTRIES) to prevent memory exhaustion
- **AND** oldest entries shall be evicted when bounds are exceeded

## Acceptance Criteria

| ID    | Criterion | Testable |
| ----- | --------- | -------- |
| AC2.1 | The `webhookAuthMiddleware` checks `Content-Length` header before HMAC verification | true |
| AC2.2 | Requests with `Content-Length` exceeding `MAX_WEBHOOK_PAYLOAD_BYTES` (default 1048576) are rejected with HTTP 413 before any HMAC computation | true |
| AC2.3 | When `Content-Length` is missing, the middleware reads body with a streaming size limit and aborts if exceeded | true |
| AC2.4 | The size check occurs BEFORE the `validateWebhookSignature()` call in the middleware code flow | true |
| AC2.5 | `MAX_WEBHOOK_PAYLOAD_BYTES` is configurable via environment variable with 1048576 as default | true |
| AC2.6 | The Express `json()` body parser in `index.ts` is configured with a `limit` option matching or below the webhook payload limit | true |
| AC2.7 | In-memory collections in `dashboardRateLimiting.middleware.ts` have capacity bounds (MAX_EVENTS, MAX_ENTRIES constants) and evict oldest entries when bounds are exceeded | true |

## Task List

- [ ] T2.1: Add `Content-Length` check to `webhookAuthMiddleware` before HMAC verification, rejecting with 413 if exceeded (AC2.1, AC2.2, AC2.4)
  - Dependencies: none
  - Outcome: Oversized requests rejected before HMAC computation
- [ ] T2.2: Add streaming body size limit for requests without `Content-Length` header (AC2.3)
  - Dependencies: T2.1
  - Outcome: Missing Content-Length requests are still bounded
- [ ] T2.3: Make `MAX_WEBHOOK_PAYLOAD_BYTES` configurable via env var with 1048576 default (AC2.5)
  - Dependencies: none
  - Outcome: Size limit is configurable at deploy time
- [ ] T2.4: Add `limit` option to `express.json()` in `apps/node-server/src/index.ts` (AC2.6)
  - Dependencies: none
  - Outcome: Express body parser rejects oversized bodies globally
- [ ] T2.5: Add capacity bounds (MAX_EVENTS, MAX_ENTRIES) to in-memory collections in `dashboardRateLimiting.middleware.ts` with oldest-entry eviction (AC2.7)
  - Dependencies: none
  - Outcome: Maps enforce capacity limits, evict oldest entries when full; prevents memory exhaustion from unbounded growth

## Evidence Table

| AC    | Implementation File | Test File | Status |
| ----- | ------------------- | --------- | ------ |
| AC2.1 | `apps/node-server/src/middleware/webhookAuth.middleware.ts` | TBD | pending |
| AC2.2 | `apps/node-server/src/middleware/webhookAuth.middleware.ts` | TBD | pending |
| AC2.3 | `apps/node-server/src/middleware/webhookAuth.middleware.ts` | TBD | pending |
| AC2.4 | `apps/node-server/src/middleware/webhookAuth.middleware.ts` | TBD | pending |
| AC2.5 | `apps/node-server/src/middleware/webhookAuth.middleware.ts` | TBD | pending |
| AC2.6 | `apps/node-server/src/index.ts` | TBD | pending |
| AC2.7 | `apps/node-server/src/middleware/dashboardRateLimiting.middleware.ts` | TBD | pending |

## Test Strategy

Test in isolation by:
1. Unit testing `webhookAuthMiddleware` with a mock request that has `Content-Length` exceeding limit -- verify 413 response and no HMAC call
2. Unit testing `webhookAuthMiddleware` with a request within limit -- verify normal processing continues
3. Unit testing with missing `Content-Length` header -- verify streaming limit enforced
4. Unit testing configurable limit via `process.env.MAX_WEBHOOK_PAYLOAD_BYTES`
5. Integration testing Express `json()` limit rejects oversized POST bodies
6. Unit testing `dashboardRateLimiting.middleware.ts` capacity bounds enforce MAX_ENTRIES limit and evict oldest entries when full

## Deployment Notes

Adding a body size limit may reject legitimate large payloads if they exist. Current webhook payloads (agent task status updates) are small JSON objects. The 1MB default provides generous headroom. Monitor 413 responses after deployment.

## Rollback Strategy

Remove the Content-Length check from `webhookAuthMiddleware`, remove the `limit` option from `express.json()`, and remove capacity bounds from `dashboardRateLimiting.middleware.ts`. No data migration required.

## Atomicity Justification

| Criterion | Justification |
| --------- | ------------- |
| independently_testable | Size guard can be tested in isolation with mock requests of varying Content-Length values. |
| independently_deployable | This is a self-contained middleware change with no dependencies on other specs. |
| independently_reviewable | Changes are limited to `webhookAuth.middleware.ts`, `index.ts`, and `dashboardRateLimiting.middleware.ts` -- a focused DoS prevention review scope. |
| independently_reversible | Removing the size check restores original behavior. No schema or data changes. |
