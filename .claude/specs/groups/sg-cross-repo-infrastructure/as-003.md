---
id: as-003-stale-artifact-detection
title: Stale Artifact Detection for Deploys
date: 2026-02-20
status: pending
parent_spec: sg-cross-repo-infrastructure
requirements_refs: [REQ-014, REQ-015, REQ-016, REQ-017, REQ-018]
---

# AS-003: Stale Artifact Detection for Deploys

## Description

Create `scripts/utils/cdk-freshness.mjs` providing `getNewestFileInDir()`, `checkArtifactFreshness()`, `formatTimeDelta()`, and `formatTimestamp()` utilities, then integrate a freshness gate into `scripts/cdk.mjs` deploy command that blocks deployment when built artifacts are older than their source files.

## Context

The monorepo's `scripts/cdk.mjs` has a `cmdDeploy()` function that deploys CDKTF stacks. It validates that required artifacts exist (`checkArtifactExists`) and that upstream stack outputs are present, but it does NOT check whether artifacts are fresher than their source code. This means you can deploy with a day-old `lambda.zip` after making source changes -- a proven class of deploy bug. The ai-eng-dashboard (commits `9491671`, `387c923`) has a `scripts/utils/cdk-freshness.mjs` utility (110 lines) with symlink loop protection and a clear integration pattern in the deploy command.

## Goal

Port the stale artifact detection utility and integrate it into the monorepo's deploy flow, configured with the correct artifact-to-source directory mappings for this monorepo's lambda and website stacks.

## Requirements

See `requirements.md` REQ-014 through REQ-018.

| ID      | Title                                      | Priority  |
| ------- | ------------------------------------------ | --------- |
| REQ-014 | getNewestFileInDir with symlink protection | Must Have |
| REQ-015 | checkArtifactFreshness comparator          | Must Have |
| REQ-016 | Deploy command freshness gate              | Must Have |
| REQ-017 | --acknowledge-stale flag behavior          | Must Have |
| REQ-018 | ARTIFACT_SOURCE_DIRS monorepo mappings     | Must Have |

## Acceptance Criteria

- **AC1.1**: `getNewestFileInDir(dirPath)` returns `{ path, mtime }` for the most recently modified file in the directory tree, or `null` if directory is empty or missing
- **AC1.2**: `getNewestFileInDir` excludes `node_modules` and `.git` directories from traversal
- **AC1.3**: `getNewestFileInDir` uses a `visited` Set with `realpathSync` to detect and skip symlink loops without infinite recursion
- **AC1.4**: `formatTimeDelta(deltaMs)` returns human-readable strings (e.g., `"23h 15m"`, `"2d 5h"`, `"45m"`, `"30s"`)
- **AC1.5**: `formatTimestamp(date)` returns strings in `"YYYY-MM-DD HH:mm:ss"` format
- **AC2.1**: `checkArtifactFreshness(artifactPath, sourceDirs, thresholdMs?)` compares artifact mtime against the newest source file mtime and returns `{ stale, artifactMtime, newestSourceMtime, delta, newestSourcePath }`. Note: this is a NEW function to be created in `cdk-freshness.mjs` (not porting an existing export from the reference -- the reference only exports `getNewestFileInDir`, `formatTimeDelta`, `formatTimestamp`; `checkArtifactFreshness` is inline in the reference's `cdk.mjs`).
- **AC2.2**: When artifact does not exist, `checkArtifactFreshness` returns `{ stale: true }` with `artifactMtime: null`
- **AC2.3**: `ARTIFACT_SOURCE_DIRS` maps the monorepo's actual artifacts to their source directories: `lambdas/api/lambda.zip` maps to `apps/node-server/src` and `packages/core/backend-core/src`; `lambdas/analytics/analytics-processor-lambda.zip` maps to `apps/analytics-lambda/src` and `packages/core/backend-core/src`
- **AC3.1**: `scripts/cdk.mjs` `cmdDeploy()` calls `checkArtifactFreshness()` for each stack's required artifacts before deploying
- **AC3.2**: When a stale artifact is detected, deploy is blocked with an error message showing artifact timestamp, source timestamp, and time delta
- **AC3.3**: `--acknowledge-stale` flag bypasses the freshness check (user explicitly accepts risk)
- **AC3.4**: `--force` flag does NOT bypass the freshness check (intentional design -- `--force` skips validation, not freshness)
- **AC3.5**: The `--acknowledge-stale` flag is documented in the usage/help output of `scripts/cdk.mjs`

## Task List

- [ ] Task 1: Create `scripts/utils/cdk-freshness.mjs` with `getNewestFileInDir()`, `formatTimeDelta()`, `formatTimestamp()` (depends on: none)
  - Outcome: Utility functions exported, symlink loop protection works
- [ ] Task 2: Implement `checkArtifactFreshness()` in `scripts/utils/cdk-freshness.mjs` (depends on: Task 1)
  - Outcome: Function compares artifact vs source mtimes, returns structured result
- [ ] Task 3: Define `ARTIFACT_SOURCE_DIRS` map with monorepo-specific mappings (depends on: none)
  - Outcome: Map correctly associates each lambda.zip with its source directories
- [ ] Task 4: Integrate freshness gate into `cmdDeploy()` in `scripts/cdk.mjs` (depends on: Tasks 2, 3)
  - Outcome: Deploy blocked on stale artifacts with clear error messages
- [ ] Task 5: Add `--acknowledge-stale` flag to argument parser in `scripts/cdk.mjs` (depends on: Task 4)
  - Outcome: Flag parsed, bypasses freshness check, documented in help text
- [ ] Task 6: Write unit tests for `cdk-freshness.mjs` (depends on: Tasks 1, 2)
  - Outcome: Tests at `scripts/__tests__/cdk-freshness.test.mjs` covering symlink loops, freshness comparisons, time formatting

## Evidence Table

| AC    | Evidence Type  | File Path                                     | Status  |
| ----- | -------------- | --------------------------------------------- | ------- |
| AC1.1 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC1.2 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC1.3 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC1.4 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC1.5 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC2.1 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC2.2 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC2.3 | Implementation | `scripts/utils/cdk-freshness.mjs`             | pending |
| AC3.1 | Implementation | `scripts/cdk.mjs`                             | pending |
| AC3.2 | Implementation | `scripts/cdk.mjs`                             | pending |
| AC3.3 | Implementation | `scripts/cdk.mjs`                             | pending |
| AC3.4 | Implementation | `scripts/cdk.mjs`                             | pending |
| AC3.5 | Implementation | `scripts/cdk.mjs`                             | pending |
| ALL   | Test           | `scripts/__tests__/cdk-freshness.test.mjs`    | pending |

## Dependencies

- None. This spec modifies `scripts/cdk.mjs` (existing file) and adds `scripts/utils/cdk-freshness.mjs` (new file).

## Atomicity Justification

- **Independently testable**: Utility functions testable with temp directories and mock files; integration testable by calling `cmdDeploy` with mock artifacts
- **Independently deployable**: New utility file + localized changes to `cmdDeploy()` and argument parser in `cdk.mjs`
- **Independently reviewable**: Clear boundary -- one new utility file and one modified script
- **Independently reversible**: Remove `cdk-freshness.mjs`, revert `cdk.mjs` changes -- deploy returns to pre-check behavior

## Test Strategy

Unit tests using Node.js test runner or Vitest. Create temp directories with files at known mtimes to test `getNewestFileInDir`. Create symlink loops to verify loop protection. Test `checkArtifactFreshness` with stale and fresh scenarios. Test `formatTimeDelta` with various ms values. Integration: test that `cmdDeploy` rejects stale artifacts and accepts `--acknowledge-stale`.

## Deployment Notes

No infrastructure changes. Modifies the deploy script only. The freshness check runs locally before any cloud operations. New `--acknowledge-stale` flag is additive (no existing workflows break).

## Rollback Strategy

Revert changes to `scripts/cdk.mjs` (remove freshness gate and `--acknowledge-stale` parsing). Delete `scripts/utils/cdk-freshness.mjs`. Deploy behavior returns to previous state (no freshness checking).
