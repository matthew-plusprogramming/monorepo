---
id: as-004-selective-claude-copy
title: Selective .claude/ Copy for Worktrees
date: 2026-02-20
status: pending
parent_spec: sg-cross-repo-infrastructure
requirements_refs: [REQ-019, REQ-020, REQ-021, REQ-022]
---

# AS-004: Selective .claude/ Copy for Worktrees

## Description

Create `.claude/scripts/selective-claude-copy.mjs` providing `selectiveCopyClaudeDir()`, `extractSpecGroupId()`, and `cleanupExcludedDirs()` utilities, then integrate selective `.claude/` copying into `manage-worktrees.mjs` so worktrees get operational items (skills, agents, templates, scripts, schemas, settings) but not state directories (specs/groups, context, memory-bank, journal).

## Context

The monorepo's `.claude/scripts/manage-worktrees.mjs` creates git worktrees for parallel workstreams. It syncs `cdktf-outputs` and `.env.keys` into worktrees, but does not handle `.claude/` directory isolation. Worktrees get the full `.claude/` directory via git (including specs, context, memory-bank, journals) which causes state pollution across parallel workstreams. The ai-eng-dashboard has a proven `selective-claude-copy.mjs` utility that copies only operational items using an include-list approach.

## Goal

Port the selective `.claude/` copy utility and integrate it into the monorepo's worktree management so that new worktrees have full Claude Code operational capability (skills, agents, scripts) without inheriting state from the parent repo.

## Requirements

See `requirements.md` REQ-019 through REQ-022.

| ID      | Title                              | Priority    |
| ------- | ---------------------------------- | ----------- |
| REQ-019 | Selective operational copy         | Should Have |
| REQ-020 | State directory exclusion          | Should Have |
| REQ-021 | extractSpecGroupId from branch     | Should Have |
| REQ-022 | Worktree Claude Code functionality | Should Have |

## Acceptance Criteria

- **AC1.1**: `CLAUDE_INCLUDE_LIST` constant contains exactly: `skills`, `agents`, `templates`, `scripts`, `schemas`, `specs/schema`, `settings.json`
- **AC1.2**: `selectiveCopyClaudeDir(sourceDir, targetDir)` copies only items in `CLAUDE_INCLUDE_LIST` from source to target
- **AC1.3**: `selectiveCopyClaudeDir` returns `{ copied: string[], skipped: string[] }` summary
- **AC1.4**: Items not in the include list are NOT copied (specifically: `specs/groups`, `context`, `memory-bank`, `journal`, `docs`, `specs/archive`, `contracts`)
- **AC1.5**: Missing source items are skipped gracefully (no error thrown, added to `skipped` array)
- **AC2.1**: `extractSpecGroupId("sg-auth-system/fix-logout")` returns `"sg-auth-system"`
- **AC2.2**: `extractSpecGroupId("feature/random-branch")` returns `null`
- **AC2.3**: `extractSpecGroupId(null)` and `extractSpecGroupId(undefined)` return `null` (no error)
- **AC3.1**: `cleanupExcludedDirs(claudeDir)` removes excluded state directories from an existing `.claude/` directory
- **AC3.2**: `cleanupExcludedDirs` returns array of directory names that were removed
- **AC4.1**: `manage-worktrees.mjs` `ensureWorktrees()` calls `selectiveCopyClaudeDir` after creating each worktree
- **AC4.2**: After worktree creation, Claude Code can load skills and agents from the worktree's `.claude/` directory

## Task List

- [ ] Task 1: Create `.claude/scripts/selective-claude-copy.mjs` with `CLAUDE_INCLUDE_LIST`, `copyRecursive()`, `selectiveCopyClaudeDir()` (depends on: none)
  - Outcome: Selective copy utility works standalone, returns copied/skipped summary
- [ ] Task 2: Implement `extractSpecGroupId()` with regex pattern matching (depends on: none)
  - Outcome: Function correctly parses `sg-*/*` branch names, returns null for non-matching
- [ ] Task 3: Implement `cleanupExcludedDirs()` with recursive directory removal (depends on: none)
  - Outcome: Function removes excluded dirs from existing `.claude/` directory
- [ ] Task 4: Integrate `selectiveCopyClaudeDir` into `manage-worktrees.mjs` `ensureWorktrees()` function (depends on: Task 1)
  - Outcome: New worktrees get operational `.claude/` items automatically
- [ ] Task 5: Write unit tests for all exported functions (depends on: Tasks 1, 2, 3)
  - Outcome: Tests at `.claude/scripts/__tests__/selective-claude-copy.test.mjs`

## Evidence Table

| AC    | Evidence Type  | File Path                                                     | Status  |
| ----- | -------------- | ------------------------------------------------------------- | ------- |
| AC1.1 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC1.2 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC1.3 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC1.4 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC1.5 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC2.1 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC2.2 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC2.3 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC3.1 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC3.2 | Implementation | `.claude/scripts/selective-claude-copy.mjs`                   | pending |
| AC4.1 | Implementation | `.claude/scripts/manage-worktrees.mjs`                        | pending |
| AC4.2 | Test           | `.claude/scripts/__tests__/selective-claude-copy.test.mjs`    | pending |
| ALL   | Test           | `.claude/scripts/__tests__/selective-claude-copy.test.mjs`    | pending |

## Dependencies

- None. This spec adds a new utility script and modifies `manage-worktrees.mjs` (existing file).

## Atomicity Justification

- **Independently testable**: All utility functions testable with temp directories; integration testable by creating mock worktrees
- **Independently deployable**: New script file + localized import/call in `manage-worktrees.mjs` `ensureWorktrees()`
- **Independently reviewable**: One new utility file, one modified script with a single integration point
- **Independently reversible**: Delete `selective-claude-copy.mjs`, remove import/call from `manage-worktrees.mjs` -- worktrees return to previous behavior (full `.claude/` via git)

## Test Strategy

Unit tests using Node.js test runner. Create temp directory trees mimicking `.claude/` structure with both operational and state directories. Verify `selectiveCopyClaudeDir` copies only include-list items. Verify `extractSpecGroupId` with various branch name patterns. Verify `cleanupExcludedDirs` removes only excluded directories. Integration: create a mock worktree and verify selective copy is called.

## Deployment Notes

No infrastructure changes. Adds a new script to `.claude/scripts/` and modifies the worktree management script. The selective copy only runs during worktree creation (not existing workflows).

## Rollback Strategy

Delete `.claude/scripts/selective-claude-copy.mjs`. Revert the `manage-worktrees.mjs` changes (remove import and `selectiveCopyClaudeDir` call). Worktrees return to receiving full `.claude/` directory via git checkout.
