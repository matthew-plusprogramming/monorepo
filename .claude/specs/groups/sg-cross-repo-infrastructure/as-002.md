---
id: as-002-correlation-context
title: Correlation Context via AsyncLocalStorage
date: 2026-02-20
status: pending
parent_spec: sg-cross-repo-infrastructure
requirements_refs: [REQ-008, REQ-009, REQ-010, REQ-011, REQ-012, REQ-013]
---

# AS-002: Correlation Context via AsyncLocalStorage

## Description

Create `correlation-context.ts` and `correlated-fetch.ts` in `packages/core/backend-core/src/services/` providing AsyncLocalStorage-based correlation context for threading request/correlation IDs through async operations, with a fetch wrapper that auto-injects correlation headers for cross-service propagation.

## Context

The monorepo has three apps (`node-server`, `analytics-lambda`, `admin-portal`) with no cross-service request tracing. Debugging request flows across services requires manual log correlation. The ai-eng-dashboard (commit `9fbc6a5`) has a proven `correlation-context.ts` module using Node.js `AsyncLocalStorage` with `runWithCorrelation()`, `getCorrelation()`, `getCorrelationHeaders()` API, plus a `correlatedFetch()` wrapper that auto-injects `x-request-id` and `x-correlation-id` headers.

## Goal

Add correlation context infrastructure to `packages/core/backend-core` that allows any service to establish, retrieve, and propagate correlation IDs across async boundaries and HTTP calls, with zero external dependencies.

## Requirements

See `requirements.md` REQ-008 through REQ-013.

| ID      | Title                                      | Priority  |
| ------- | ------------------------------------------ | --------- |
| REQ-008 | AsyncLocalStorage correlation context      | Must Have |
| REQ-009 | getCorrelation() with graceful degradation | Must Have |
| REQ-010 | Correlation headers generation             | Must Have |
| REQ-011 | correlatedFetch wrapper                    | Must Have |
| REQ-012 | Correlation ID validation                  | Must Have |
| REQ-013 | Zero external dependencies                 | Must Have |

## Acceptance Criteria

- **AC1.1**: `CorrelationStore` interface exported with fields: `requestId?`, `correlationId?`, `jobId?`, `workflowId?`
- **AC1.2**: Module-scoped singleton `AsyncLocalStorage<CorrelationStore>` instance exists (not exported directly)
- **AC1.3**: `runWithCorrelation(store, fn)` executes `fn` within an ALS context; all async descendants can access the store
- **AC1.4**: `getCorrelation()` returns the current `CorrelationStore` when called within ALS context
- **AC1.5**: `getCorrelation()` returns `undefined` when called outside any ALS context (no error thrown)
- **AC1.6**: `getCorrelationHeaders()` returns `Record<string, string>` with `x-request-id` and `x-correlation-id` from store
- **AC1.7**: `getCorrelationHeaders()` returns `{}` (empty object) when called outside ALS context
- **AC2.1**: `correlatedFetch(url, init?)` calls native `fetch` with correlation headers injected
- **AC2.2**: Caller-provided headers in `init.headers` override correlation headers on key conflict
- **AC2.3**: `correlatedFetch` handles `Headers` objects, `string[][]`, and `Record<string, string>` header formats
- **AC2.4**: When called outside ALS context, `correlatedFetch` behaves identically to native `fetch` (no headers added, no error)
- **AC2.5**: Correlation IDs are validated at ingest boundaries using regex `^[a-zA-Z0-9._-]{1,128}$`
- **AC2.6**: The module imports only from `node:async_hooks` (zero external dependencies)

## Description

Single testable behavior: AsyncLocalStorage-based correlation context establishment, retrieval, header generation, and fetch wrapper with correlation header injection.

## Task List

- [ ] Task 1: Create `packages/core/backend-core/src/services/correlation-context.ts` with `CorrelationStore` type, singleton ALS instance, `runWithCorrelation()`, `getCorrelation()`, `getCorrelationHeaders()` (depends on: none)
  - Outcome: All three functions exported and working with ALS context
- [ ] Task 2: Add correlation ID validation function with regex `^[a-zA-Z0-9._-]{1,128}$` (depends on: Task 1)
  - Outcome: `validateCorrelationId(id)` returns boolean, exported for use at ingest boundaries
- [ ] Task 3: Create `packages/core/backend-core/src/services/correlated-fetch.ts` with `correlatedFetch()` and `normalizeHeaders()` (depends on: Task 1)
  - Outcome: Fetch wrapper auto-injects correlation headers, handles all header formats
- [ ] Task 4: Write unit tests for correlation-context.ts (depends on: Tasks 1, 2)
  - Outcome: Tests at `packages/core/backend-core/src/__tests__/services/correlation-context.test.ts`
- [ ] Task 5: Write unit tests for correlated-fetch.ts (depends on: Task 3)
  - Outcome: Tests at `packages/core/backend-core/src/__tests__/services/correlated-fetch.test.ts`

## Evidence Table

| AC    | Evidence Type  | File Path                                                                     | Status  |
| ----- | -------------- | ----------------------------------------------------------------------------- | ------- |
| AC1.1 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC1.2 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC1.3 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC1.4 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC1.5 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC1.6 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC1.7 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC2.1 | Implementation | `packages/core/backend-core/src/services/correlated-fetch.ts`                 | pending |
| AC2.2 | Implementation | `packages/core/backend-core/src/services/correlated-fetch.ts`                 | pending |
| AC2.3 | Implementation | `packages/core/backend-core/src/services/correlated-fetch.ts`                 | pending |
| AC2.4 | Implementation | `packages/core/backend-core/src/services/correlated-fetch.ts`                 | pending |
| AC2.5 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| AC2.6 | Implementation | `packages/core/backend-core/src/services/correlation-context.ts`              | pending |
| ALL   | Test           | `packages/core/backend-core/src/__tests__/services/correlation-context.test.ts` | pending |
| ALL   | Test           | `packages/core/backend-core/src/__tests__/services/correlated-fetch.test.ts`  | pending |

## Dependencies

- Soft dependency on AS-001: The structured logger can auto-enrich log entries with correlation IDs from the ALS context, but both modules work independently.

## Atomicity Justification

- **Independently testable**: ALS context can be tested in isolation with `runWithCorrelation` wrapping test assertions; fetch wrapper testable by mocking global `fetch`
- **Independently deployable**: Two new files added to `packages/core/backend-core/src/services/` with no changes to existing code
- **Independently reviewable**: Self-contained module pair (context + fetch wrapper) with clear boundary
- **Independently reversible**: Delete both files; no existing code depends on them until callers explicitly import

## Test Strategy

Unit tests using Vitest. Test `runWithCorrelation` by asserting `getCorrelation()` returns the store within the callback and `undefined` outside. Test `getCorrelationHeaders()` returns correct header mapping. Test `correlatedFetch` by mocking global `fetch` and asserting headers are injected. Test all three `HeadersInit` formats (plain object, Headers instance, string[][]). Test validation regex with valid/invalid correlation IDs.

## Deployment Notes

No infrastructure changes. Pure TypeScript module addition. Only imports `node:async_hooks` which is a stable Node.js API available since Node 12.

## Rollback Strategy

Delete `correlation-context.ts` and `correlated-fetch.ts`. No callers depend on them until explicitly adopted.
