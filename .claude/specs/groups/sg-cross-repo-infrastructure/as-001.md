---
id: as-001-structured-json-logger
title: Structured JSON Logger with PII Redaction
date: 2026-02-20
status: pending
parent_spec: sg-cross-repo-infrastructure
requirements_refs: [REQ-001, REQ-002, REQ-003, REQ-004, REQ-005, REQ-006, REQ-007]
---

# AS-001: Structured JSON Logger with PII Redaction

## Description

Create a `createStructuredLogger(config)` factory in `packages/core/backend-core/src/services/structured-logger.ts` that outputs single-line JSON to stdout with recursive PII redaction of sensitive fields, log level filtering via `LOG_LEVEL` env var, 8KB size truncation, and circular reference protection. Extend the existing `LoggerService` interface with `logWarn`.

## Context

The monorepo's `LoggerService` in `packages/core/backend-core/src/services/logger.ts` is a 20-line Effect-TS Context tag with three methods (`log`, `logError`, `logDebug`). It provides no structured output, no PII protection, no log level filtering, and no `logWarn` method. The ai-eng-dashboard has a proven `structured-logger.ts` (commits `87ba94d`, `0233149`) that outputs single-line JSON to stdout with recursive PII redaction, level filtering, size truncation, and circular reference protection.

## Goal

Create `structured-logger.ts` alongside the existing logger in `packages/core/backend-core/src/services/` that provides a `createStructuredLogger(config)` factory outputting machine-parseable JSON to stdout with PII redaction, log level filtering, and size safety. Extend the existing `LoggerService` interface with `logWarn` for backward compatibility.

## Requirements

See `requirements.md` REQ-001 through REQ-007.

| ID      | Title                              | Priority  |
| ------- | ---------------------------------- | --------- |
| REQ-001 | Structured logger factory          | Must Have |
| REQ-002 | PII redaction in log context       | Must Have |
| REQ-003 | LOG_LEVEL env var filtering        | Must Have |
| REQ-004 | Log entry size truncation (8KB)    | Must Have |
| REQ-005 | Circular reference protection      | Must Have |
| REQ-006 | Base field override protection     | Must Have |
| REQ-007 | LoggerService backward compat      | Must Have |

## Acceptance Criteria

- **AC1.1**: `createStructuredLogger({ service, component })` returns an object with `info`, `warn`, `error`, `debug` methods
- **AC1.2**: Each method writes a single-line JSON string to `process.stdout.write` (not `console.log`) followed by a newline
- **AC1.3**: Each log entry contains `timestamp` (ISO 8601), `service`, `component`, `env`, `version`, `level`, `message` fields
- **AC1.4**: Additional context passed as second argument is spread into the log entry after PII redaction
- **AC1.5**: A shared `SENSITIVE_KEYS` constant is exported from `packages/core/backend-core/src/constants/sensitive-keys.ts` containing at least: email, phone, address, dob, ssn, password, token, secret, key, authorization, cookie, session, credit_card, apikey, api_key, accesstoken, access_token, refreshtoken, refresh_token, bearer. Both the structured logger AND the existing logging middleware (`apps/node-server/src/middleware/logging.middleware.ts`) import from this shared constant. Fields matching `SENSITIVE_KEYS` are recursively replaced with `'[REDACTED]'`.
- **AC1.6**: Circular references in context objects do not crash the logger; a WeakSet-based detector produces a safe fallback
- **AC1.7**: `parseLogLevel()` follows the precedence chain: `LOG_LEVEL` env var (case-insensitive) > `DEBUG=true` > default `INFO`; invalid `LOG_LEVEL` values warn to stderr and default to INFO
- **AC2.1**: Log entries below the configured level are silently suppressed (e.g., `debug()` is suppressed when level is INFO)
- **AC2.2**: Serialized log entries exceeding 8192 characters are truncated; the truncated entry includes `[TRUNCATED]` in the message
- **AC2.3**: Caller context fields named `timestamp`, `level`, `service`, or `component` do NOT override the base entry fields
- **AC2.4**: The existing `LoggerServiceSchema` type in `logger.ts` is extended with a `logWarn` method
- **AC2.5**: All existing callers of `LoggerService` (those using `log`, `logError`, `logDebug`) continue to compile and function without changes
- **AC2.6**: The test fake in `packages/core/backend-core/src/testing/fakes/logger.ts` is updated to include `logWarn` and continues to type-check against `LoggerServiceSchema`
- **AC2.7**: The logging middleware in `apps/node-server/src/middleware/logging.middleware.ts` imports `SENSITIVE_KEYS` from the shared constant at `packages/core/backend-core/src/constants/sensitive-keys.ts` (eliminating the duplicate `SENSITIVE_FIELDS` inline set)
- **AC2.8**: If the `correlation-context` module (AS-002) is not available, the structured logger operates without correlation enrichment -- no import error is thrown. The logger uses a conditional/optional import pattern so it can be deployed independently of AS-002.

## Task List

- [ ] Task 1: Create `packages/core/backend-core/src/services/structured-logger.ts` with types (`LogLevel`, `LogContext`, `StructuredLoggerConfig`, `StructuredLogEntry`, `StructuredLogger`) (depends on: none)
  - Outcome: Type definitions exported and importable
- [ ] Task 2: Implement `SENSITIVE_KEYS` set and `redactSensitiveFields()` with WeakSet circular reference protection (depends on: Task 1)
  - Outcome: Recursive redaction works on nested objects and arrays, handles circular refs
- [ ] Task 3: Implement `parseLogLevel()` with `LOG_LEVEL` > `DEBUG=true` > `INFO` fallback chain (depends on: Task 1)
  - Outcome: Function correctly parses env vars and warns on invalid values
- [ ] Task 4: Implement `createStructuredLogger()` factory with level filtering, PII redaction, size truncation, base field protection, `process.stdout.write` output (depends on: Tasks 2, 3)
  - Outcome: Factory produces logger that satisfies AC1.1 through AC2.3
- [ ] Task 5: Add `logWarn` to `LoggerServiceSchema` in `logger.ts` (depends on: none)
  - Outcome: Interface extended, existing callers unaffected (additive change)
- [ ] Task 6: Create shared `SENSITIVE_KEYS` constant at `packages/core/backend-core/src/constants/sensitive-keys.ts` (depends on: none)
  - Outcome: Shared constant exported, importable by both the structured logger and the logging middleware
- [ ] Task 7: Update `apps/node-server/src/middleware/logging.middleware.ts` to import `SENSITIVE_KEYS` from the shared constant instead of its own inline `SENSITIVE_FIELDS` (depends on: Task 6)
  - Outcome: Logging middleware uses the shared constant; existing redaction behavior is preserved or extended to the full set
- [ ] Task 8: Update the test fake at `packages/core/backend-core/src/testing/fakes/logger.ts` to include `logWarn` method (depends on: Task 5)
  - Outcome: The fake implements `LoggerServiceSchema` including `logWarn` and continues to type-check
- [ ] Task 9: Write unit tests for all acceptance criteria (depends on: Tasks 4, 5, 6, 7, 8)
  - Outcome: Tests at `packages/core/backend-core/src/__tests__/services/structured-logger.test.ts`

## Evidence Table

| AC    | Evidence Type | File Path                                                                | Status  |
| ----- | ------------- | ------------------------------------------------------------------------ | ------- |
| AC1.1 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC1.2 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC1.3 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC1.4 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC1.5 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC1.6 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC1.7 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC2.1 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC2.2 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC2.3 | Implementation | `packages/core/backend-core/src/services/structured-logger.ts`          | pending |
| AC2.4 | Implementation | `packages/core/backend-core/src/services/logger.ts`                     | pending |
| AC2.5 | Test          | `packages/core/backend-core/src/__tests__/services/structured-logger.test.ts` | pending |
| AC2.6 | Implementation | `packages/core/backend-core/src/testing/fakes/logger.ts`                | pending |
| AC2.7 | Implementation | `apps/node-server/src/middleware/logging.middleware.ts`                  | pending |
| AC2.8 | Test          | `packages/core/backend-core/src/__tests__/services/structured-logger.test.ts` | pending |
| ALL   | Test          | `packages/core/backend-core/src/__tests__/services/structured-logger.test.ts` | pending |

## Dependencies

- **Optional enhancement on AS-002**: The structured logger can auto-enrich log entries with correlation IDs from the ALS context if the `correlation-context` module (AS-002) exists. However, this is a soft/optional dependency -- the logger MUST work without AS-002 installed (use conditional/optional import pattern, gracefully degrade to no correlation enrichment).

## Atomicity Justification

- **Independently testable**: All ACs can be verified by unit tests that mock `process.stdout.write` and `process.env`
- **Independently deployable**: New file `structured-logger.ts` + additive `logWarn` on existing interface -- no breaking changes
- **Independently reviewable**: Self-contained module with clear boundary (single file + interface extension)
- **Independently reversible**: Delete `structured-logger.ts`, remove `logWarn` from interface -- no downstream impact until callers adopt

## Test Strategy

Unit tests using Vitest. Mock `process.stdout.write` to capture output. Set `process.env.LOG_LEVEL` and `process.env.DEBUG` for level filtering tests. Create circular reference objects to verify crash protection. Verify serialized output is valid JSON with expected fields.

## Deployment Notes

No infrastructure changes. Pure TypeScript module addition. The `logWarn` interface addition is backward compatible (existing implementations that don't provide it will get a type error only if they explicitly implement the interface -- Effect-TS tag resolution handles this).

## Rollback Strategy

Remove `structured-logger.ts` file. Revert `logWarn` addition to `LoggerServiceSchema`. No callers depend on either until explicitly adopted.
